<!DOCTYPE html>
<html>

<head>
  <title>2750E - EST</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
   <script src="https://unpkg.com/jspsych@7.3.0"></script>
   <script src="https://unpkg.com/@jspsych/plugin-animation@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-audio-slider-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-browser-check@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-canvas-button-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-canvas-keyboard-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-canvas-slider-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-categorize-animation@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-categorize-html@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-categorize-image@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-cloze@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-external-html@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-free-sort@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-html-audio-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-html-video-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-iat-html@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-iat-image@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-image-button-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-image-slider-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-initialize-camera@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-initialize-microphone@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-maxdiff@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-mirror-camera@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-reconstruction@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-resize@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-same-different-html@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-same-different-image@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-serial-reaction-time@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-serial-reaction-time-mouse@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-sketchpad@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-survey-multi-select@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-video-button-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-video-keyboard-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-video-slider-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-virtual-chinrest@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-visual-search-circle@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-video-button-response@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-webgazer-calibrate@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-webgazer-init-camera@1.1.1"></script>
   <script src="https://unpkg.com/@jspsych/plugin-webgazer-validate@1.1.1"></script>

  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" type="text/css" />
  <link href="css/buttons.css" rel="stylesheet" type="text/css">

</head>

<body>
  <script>
    ////////////////////
    //Global Variables//
    ////////////////////

    //Define timeline
    var jsPsych = initJsPsych({on_finish: function(){jsPsych.data.get().localSave('csv','mydata-est.csv');}}); //initialize jsPsych before loading any js modules that depend on it!
    var timeline = []; //specify the jsPsych timeline to which all trials/blocks are pushed

    //Participant Identifier
    var identifier = Math.random().toString(36).substr(2, 15); //random alphanumeric string for ID

    jsPsych.data.addProperties({
      random_id: identifier,
    }); //add participant ID to data output


/**************************/
/** PITCH ADJUSTMENT **/
/**************************/
/*
This module consists of an auditory adjustment / recreation
task. It has been used as a measure of auditory workingal
memory precision. It has been used with sine tones, button
really any continuum of sounds can be used.

Van Hedger et al. (2015) Auditory working memory predicts
individual differences in absolute pitch learning. Cognition,
140, 95-110.

On each trial, participant hear a target sound. This is then
masked by noise. Participants then hear a starting tone and
have to try to recreate the target tone as accurately as
possible.

The script outputs two important variables. The first is
'pitchadjust' which should be added to the experiment timeline
in the main html file -- e.g., timeline.push(pitchadjust);

The second is 'return_pitchadjust_folder' which should be pushed or
concatenated with other audio files for preloading purposes.
This is a function, so users can specify a different folder
name in the main html file
-- e.g., var foldername = return_pitchadjust_folder();

Stephen Van Hedger, April 2020

*/


////////////////////
// DATA VARIABLES //
////////////////////


var allClicks = []; //this array will store ALL button clicks (up, down, play current) for a trials/blocks
var allMoves = []; //this array will store all MOVES (i.e., just when someone changes the pitch via up/down buttons)
var trialCount = 1; //this will serve as a trial counter
var practiceTrialCount = 1; //this will serve as a trial counter for practice
var currentPosition; //this will log the current position in the tone array
var targetPosition; //this will log the correct position of the tone
var quickAssessment = 1; //0 = 64 trials (2x each target/probe combo), 1 = 32 trials (1x each target/probe combo)
var targetPlayed = 0; //to ensure participants have to hear the target before anything else
var delayPeriod = 500; //the minimum time in ms between clicking on the target sound and being able to play the starting sound
var targetTone; //for preloading the target tone
var targetAudio; //for setting target audio
var noiseAudio; //for setting masking noise

///////////////
// TONE LIST //
///////////////

//full list of the tones plus pink noise
var toneList = [
"PA/01.mp3","PA/02.mp3", "PA/03.mp3", "PA/04.mp3", "PA/05.mp3",
"PA/06.mp3","PA/07.mp3", "PA/08.mp3", "PA/09.mp3", "PA/10.mp3",
"PA/11.mp3","PA/12.mp3", "PA/13.mp3", "PA/14.mp3", "PA/15.mp3",
"PA/16.mp3","PA/17.mp3", "PA/18.mp3", "PA/19.mp3", "PA/20.mp3",
"PA/21.mp3","PA/22.mp3", "PA/23.mp3", "PA/24.mp3", "PA/25.mp3",
"PA/26.mp3","PA/27.mp3", "PA/28.mp3", "PA/29.mp3", "PA/30.mp3",
"PA/31.mp3","PA/32.mp3", "PA/33.mp3", "PA/34.mp3"];

//function to return the audio folder for preloading
var preload_files = {
  type: jsPsychPreload,
  audio: toneList,
  message: 'Loading...',
  continue_after_error: false
};


//////////////////////
// BUTTON FUNCTIONS //
//////////////////////

// Functions to execute when the primary buttons are pressed (UP, DOWN, START/CURRENT, and TARGET)
function goUP() {
	if (currentPosition == (toneList.length-1)){
		currentPosition;
		} else {
		currentPosition += 1;
		}
	var playTone = toneList[currentPosition];
	var audio = document.getElementById('playerUp');
	document.getElementById('playerUp').src = playTone;
	//don't allow playing of the current tone unless target has been played
	if(targetPlayed == 1){
		audio.play(); //this actually plays the file
	} else {
		document.getElementById('warning').innerHTML = "Please play the target sound first!";
		setTimeout(function(){
			document.getElementById('warning').innerHTML = "&nbsp;";
		}, 2000)
	}
	//Log the button press in an ongoing array for the trial
	allClicks[clickindex] = 1;
	allMoves[moveindex] = 1;
	clickindex += 1;
	moveindex += 1;
};

function goDOWN() {
	if (currentPosition == 0){
		currentPosition;
		} else {
		currentPosition -= 1;
		}
	var playTone = toneList[currentPosition];
	var audio = document.getElementById('playerDown');
	document.getElementById('playerDown').src = playTone;
	//don't allow playing of the current tone unless target has been played
	if(targetPlayed == 1){
		audio.play(); //this actually plays the file
	} else {
		document.getElementById('warning').innerHTML = "Please play the target sound first!";
		setTimeout(function(){
			document.getElementById('warning').innerHTML = "&nbsp;";
		}, 2000)
	}
	//Log the button press in an ongoing array for the trial
	allClicks[clickindex] = -1;
	allMoves[moveindex] = -1;
	clickindex += 1;
	moveindex += 1;
};

function playCURRENT() {
	var playTone = toneList[currentPosition];
	var audio = document.getElementById('playerCurrent');
	document.getElementById('playerCurrent').src = playTone;
	//don't allow playing of the current tone unless target has been played
	if(targetPlayed == 1){
		audio.play(); //this actually plays the file
	} else {
		document.getElementById('warning').innerHTML = "Please play the target sound first!";
		setTimeout(function(){
			document.getElementById('warning').innerHTML = "&nbsp;";
		}, 2000)
	}
	//Log the button press in an ongoing array for the trial
	allClicks[clickindex] = 0;
	clickindex += 1;
};

//This function plays the initial target tone, followed by noise
function playTARGET() {
	/*
	var playTone = toneList[targetPosition];
	var audio = document.getElementById('playerTarget');

	document.getElementById('playerTarget').src = playTone;
	audio.play(); //this actually plays the file
	*/
	var targetbutton = document.getElementById('TBUTTON');
	targetAudio.play(); //try this
	targetbutton.style.display = 'none'; //this hides the input, preventing future plays of the target

	  /*
	setTimeout(function(){
		var noise = document.getElementById('playerTarget');
		document.getElementById('playerTarget').src = 'noise/pinknoise.mp3';
		noise.play(); //this actually plays the file
		}, 500)
		*/
	//Set the duration of the delay before participants are able to click on the other buttons.
	setTimeout(function(){
		targetPlayed = 1;
	}, delayPeriod)

};
////////////////////
// MAIN VARIABLES //
////////////////////

//This houses all of the trial combinations (i.e., starting tone/target tone combos)
//As done in Van Hedger et al. (2015) Cognition, targets are tones 13,16,19,22 in the
//array. Starting tones are 1,4,7,10 / 25,28,31,34. All combinations occur 2x for a
//total of 64 trials. Because javascript does zero-indexing, the locations are n-1.

var PA_VARS = [
{targetTone: toneList[15], probeTone: toneList[0], distance: 15, correctIndex: 15, initialPosition: 0},
{targetTone: toneList[15], probeTone: toneList[0], distance: 15, correctIndex: 15, initialPosition: 0},
{targetTone: toneList[15], probeTone: toneList[3], distance: 12, correctIndex: 15, initialPosition: 3},
{targetTone: toneList[15], probeTone: toneList[3], distance: 12, correctIndex: 15, initialPosition: 3},
{targetTone: toneList[15], probeTone: toneList[6], distance: 9, correctIndex: 15, initialPosition: 6},
{targetTone: toneList[15], probeTone: toneList[6], distance: 9, correctIndex: 15, initialPosition: 6},
{targetTone: toneList[15], probeTone: toneList[9], distance: 6, correctIndex: 15, initialPosition: 9},
{targetTone: toneList[15], probeTone: toneList[9], distance: 6, correctIndex: 15, initialPosition: 9},
{targetTone: toneList[15], probeTone: toneList[24], distance: 9, correctIndex: 15, initialPosition: 24},
{targetTone: toneList[15], probeTone: toneList[24], distance: 9, correctIndex: 15, initialPosition: 24},
{targetTone: toneList[15], probeTone: toneList[27], distance: 12, correctIndex: 15, initialPosition: 27},
{targetTone: toneList[15], probeTone: toneList[27], distance: 12, correctIndex: 15, initialPosition: 27},
{targetTone: toneList[15], probeTone: toneList[30], distance: 15, correctIndex: 15, initialPosition: 30},
{targetTone: toneList[15], probeTone: toneList[30], distance: 15, correctIndex: 15, initialPosition: 30},
{targetTone: toneList[15], probeTone: toneList[33], distance: 18, correctIndex: 15, initialPosition: 33},
{targetTone: toneList[15], probeTone: toneList[33], distance: 18, correctIndex: 15, initialPosition: 33},
];


//////////////////
// MAIN SCREENS //
//////////////////

var intro_general = {
	type: jsPsychHtmlButtonResponse,
	stimulus: '<p style="color:#e31838;"><b>Psychophysics Demonstration - Estimation/Reproduction</b></p>' +
			  '<p>In this mini-study, you will get a first-hand feel of an <b>estimation</b> task<p>' +
			  '<p>On each trial, you will try to reproduce a target tone that you hear. There are 16 trials.</p>' +
			  '<p>You can read more about how the study works on the next page.</p>',
	choices: ['Continue'],
	post_trial_gap: 200
};

//Main Instructions
var mainInstruct = {
	type: jsPsychHtmlButtonResponse,
	stimulus: '<p>This is a <b>tone estimation task</b>. We are interested in how well you are able to recreate a briefy presented tone.</p>' +
			  'At the beginning of each trial, you will play a <b>Target Tone</b> by clicking on a button labeled "T". <u>Listen carefully to this tone.</u>' +
			  '</br>You will not be able to replay it.</p>' +
			  '<p>You will then click on a button labeled "S" to hear the <b>Starting Tone</b>.</br>Your task is to adjust this Starting Tone to reproduce the Target Tone.</p>' +
			  '<p>To do this, you will click on "up" and "down" arrows on the screen to move the Starting Tone up and down, respectively.</p>' +
			  '<p>Once you think you have successfully reached the Target Tone, you will press ENTER.</p>',
	choices: ['Begin Practice']
};



//Setup
var setupScreen = {
	type: jsPsychHtmlButtonResponse,
	stimulus: function(){return '<p>Trial ' +trialCount+ ' of '+PA_VARS.length+'</p>';},
	choices: ['Begin'],
	post_trial_gap: 250,
	data: {designation: 'SETUP', start_pos: jsPsych.timelineVariable('initialPosition'), cor_pos: jsPsych.timelineVariable('correctIndex')},
	on_finish: function(data){
		clickindex = 0; //reset the click index for the upcoming trial
		moveindex = 0; //reset the move index for the upcoming trial
		allClicks = []; //reset the click array for the upcoming trial
		allMoves = []; //reset the move array for the upcoming trial
		currentPosition = data.start_pos; //this will make sure the response screen is properly set up
		targetPosition = data.cor_pos; //this will make sure the response screen is properly set to play the target
	}
};

//Setup Practice
var setupScreenPractice = {
	type: jsPsychHtmlButtonResponse,
	stimulus: function(){return '<p>Practice Trial ' +practiceTrialCount+ ' of '+PA_VARS_PRACTICE.length+'</p>';},
	choices: ['Begin'],
	post_trial_gap: 250,
	data: {designation: 'SETUP', start_pos: jsPsych.timelineVariable('initialPosition'), cor_pos: jsPsych.timelineVariable('correctIndex')},
	on_finish: function(data){
		clickindex = 0; //reset the click index for the upcoming trial
		moveindex = 0; //reset the move index for the upcoming trial
		allClicks = []; //reset the click array for the upcoming trial
		allMoves = []; //reset the move array for the upcoming trial
		practiceTrialCount += 1; //update trial counter
		currentPosition = data.start_pos; //this will make sure the response screen is properly set up
		targetPosition = data.cor_pos; //this will make sure the response screen is properly set up
	}
};


//Main Screen
var testScreen = {
	type: jsPsychHtmlKeyboardResponse,
	on_start: function(){
		targetTone = toneList[targetPosition];
		targetAudio = new Audio(targetTone);
		noiseAudio = new Audio('noise/pinknoise.mp3');},
	data: {designation: 'RESPONSE', start_pos: jsPsych.timelineVariable('initialPosition'), cor_pos: jsPsych.timelineVariable('correctIndex')},
	stimulus: '<div class="triple column"><p><input class="filler" value="&#8593;" type="button"></p><p><input class="TBUTTON" id="TBUTTON" type="button" value="T" onclick="playTARGET()"><audio id="playerTarget" src=""></audio></p></div>'+
			  '<div class="triple column"><p><input class="UBUTTON" id="UBUTTON" type="button" value="&#8593;" onclick="goUP()"><audio id="playerUp" src=""></audio></p>'+
			  '<p><input class="SBUTTON" id="SBUTTON" type="button" value="S" onclick="playCURRENT()"><audio id="playerCurrent" src=""></audio></p>'+
			  '<p><input class="DBUTTON" id="DBUTTON" type="button" value="&#8595;" onclick="goDOWN()"><audio id="playerDown" src=""></audio></p></div>',
	choices: ['Enter'],
	prompt: '<div class="w3-container"><b>Instructions</b></br>1.Click the "T" button to hear the TARGET tone. Listen carefully - you only get to hear this tone once.</br>'+
			'2. Click on the "S" button to hear the STARTING tone. </br>3. Click on the up and down arrows to move this STARTING tone to match the TARGET tone.</br></br>'+
			'You can check your current location at any time by clicking on the "S" button.</br>When you think you have successfully reached the target tone, press ENTER.</div><div id="warning" style="color:red">&nbsp;</div>',
	on_finish: function(data){
		var finalLOC = currentPosition; //where the participants ended up in the array
		var finalClicks = allClicks;
		var finalMoves = allMoves;
		var numClicks = allClicks.length;
		var numMoves = allMoves.length;
		var deviation = Math.abs(finalLOC - data.cor_pos);


		jsPsych.data.addDataToLastTrial({
			trial_count: trialCount,
			final_loc: finalLOC,
			clickTracker: finalClicks,
			moveTracker: finalMoves,
			num_clicks: numClicks,
			num_moves: numMoves,
			abs_deviation: deviation
			});

		if(trialCount == 'practice'){
			trialCount = trialCount
		} else {
			trialCount += 1; //update trial counter	for main task only
		}
		targetPlayed = 0; //reset target played before next trial commences
	}
};
var meandev; //for storing the mean deviation

//Wrap-Up
    var pa_finish = {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<p>Thank you for your responses. This concludes the sound reproduction task.</p>",
		choices: ['Continue'],
    on_finish: function(data){
      meandev = jsPsych.data.get().select('abs_deviation').mean();
      console.log(meandev);
    }
      };

var pa_summary = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: function(){var percentdev = meandev*2; return '<p>On average, you were '+meandev+ 'click(s) away from reproducing the target tone.</p>'+
                              '<p>This corresponds to approximately '+percentdev+'% deviation from estimating the target tone.</p><p>(Press s to save your data)</p>'}
}

///////////////////////////
// DEFINE THE PROCEDURES //
///////////////////////////


var mainProcedure = {
	timeline: [setupScreen, testScreen],
	timeline_variables: PA_VARS,
	randomize_order:true
}

//final procedure to push to the timeline
var pitchadjust = {
	timeline: [preload_files, intro_general, mainInstruct, mainProcedure, pa_finish, pa_summary],
	data: {task: 'INM'}
}

timeline.push(pitchadjust);

jsPsych.run(timeline);

  </script>
</body>

</html>
